<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
 <script src="https://cdn.jsdelivr.net/npm/oidc-client@1.11.5/lib/oidc-client.min.js"></script>

  <title>Patient Monitoring Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', sans-serif;
      background: #0a0e1a;
      color: #ffffff;
      line-height: 1.4;
      overflow-x: hidden;
    }

    .container {
      max-width: 1920px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      background: linear-gradient(135deg, #1a1f2e 0%, #16213e 100%);
      border: 1px solid #2a3441;
      border-radius: 4px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .header .subtitle {
      color: #8892b0;
      font-size: 14px;
      margin-bottom: 24px;
    }
    
     .header-buttons {
  display: flex;
  gap: 12px;
  align-items: center;
  position: absolute;
  right: 24px;
  top: 24px;
}

.header-btn {
  background: #1e40af;
  border: 1px solid #3b82f6;
  color: #ffffff;
  padding: 8px 16px;
  border-radius: 4px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 100px;
  text-align: center;
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.header-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.header-btn.logout {
  background: #1e40af;
  border-color: #3b82f6;
}

.header-btn.logout:hover {
  background: #1e40af;
}

.header-btn.history {
  background: #296040;
  border-color: #10b981;
}

.header-btn.history:hover {
  background: #047857;
}
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #1a1f2e;
      border: 1px solid #2a3441;
      border-radius: 4px;
      padding: 20px;
      position: relative;
      transition: border-color 0.2s ease;
    }

    .stat-card:hover {
      border-color: #4a5568;
    }

    .stat-card.critical {
      border-left: 4px solid #dc2626;
      background: linear-gradient(90deg, rgba(220, 38, 38, 0.1) 0%, #1a1f2e 100%);
    }

    .stat-card.warning {
      border-left: 4px solid #d97706;
      background: linear-gradient(90deg, rgba(217, 119, 6, 0.1) 0%, #1a1f2e 100%);
    }

    .stat-card.normal {
      border-left: 4px solid #059669;
      background: linear-gradient(90deg, rgba(5, 150, 105, 0.1) 0%, #1a1f2e 100%);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .stat-title {
      font-size: 12px;
      color: #8892b0;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .stat-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #059669;
    }

    .stat-status.critical {
      background: #dc2626;
      box-shadow: 0 0 8px rgba(220, 38, 38, 0.5);
      animation: pulse 2s infinite;
    }

    .stat-status.warning {
      background: #d97706;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
      font-family: 'Courier New', monospace;
    }

    .stat-change {
      font-size: 11px;
      color: #8892b0;
    }

    .controls {
      background: #1a1f2e;
      border: 1px solid #2a3441;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
    }

    .search-container {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 4px;
      color: #ffffff;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .search-input::placeholder {
      color: #6b7280;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
      font-size: 16px;
    }

    .filter-select {
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 4px;
      color: #ffffff;
      font-size: 14px;
      min-width: 160px;
    }

    .filter-select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .refresh-btn {
      background: #1e40af;
      border: 1px solid #3b82f6;
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .refresh-btn:hover {
      background: #1d4ed8;
    }

    .refresh-btn:disabled {
      background: #374151;
      border-color: #4b5563;
      cursor: not-allowed;
    }

    .status-indicator {
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #8892b0;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #059669;
      animation: pulse 2s infinite;
    }

    .status-dot.error {
      background: #dc2626;
    }

    .alerts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 16px;
    }

    .alert-card {
      background: #1a1f2e;
      border: 1px solid #2a3441;
      border-radius: 4px;
      overflow: hidden;
      transition: border-color 0.2s ease;
    }

    .alert-card:hover {
      border-color: #4a5568;
    }

    .alert-card.critical {
      border-left: 4px solid #dc2626;
    }

    .alert-card.warning {
      border-left: 4px solid #d97706;
    }

    .alert-card.normal {
      border-left: 4px solid #059669;
    }

    .alert-header {
      padding: 16px 20px;
      background: #0f172a;
      border-bottom: 1px solid #2a3441;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .patient-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .patient-id {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      font-family: 'Courier New', monospace;
    }

    .patient-status {
      font-size: 10px;
      color: #8892b0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .timestamp {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .severity-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .severity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .severity-indicator.critical {
      color: #dc2626;
    }

    .severity-indicator.critical .severity-dot {
      background: #dc2626;
      box-shadow: 0 0 8px rgba(220, 38, 38, 0.5);
      animation: pulse 2s infinite;
    }

    .severity-indicator.warning {
      color: #d97706;
    }

    .severity-indicator.warning .severity-dot {
      background: #d97706;
    }

    .severity-indicator.normal {
      color: #059669;
    }

    .severity-indicator.normal .severity-dot {
      background: #059669;
    }

    .vitals-container {
      padding: 20px;
    }

    .vitals-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .vital-reading {
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 4px;
      padding: 16px;
      text-align: center;
    }

    .vital-label {
      font-size: 11px;
      color: #8892b0;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .vital-value {
      font-size: 24px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      margin-bottom: 4px;
    }

    .vital-unit {
      font-size: 12px;
      color: #6b7280;
    }

    .vital-reading.heart-rate .vital-value {
      color: #ef4444;
    }

    .vital-reading.oxygen .vital-value {
      color: #3b82f6;
    }

    .vital-reading.critical .vital-value {
      animation: pulse 2s infinite;
    }

    .alerts-section {
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 4px;
      padding: 16px;
    }

    .alerts-title {
      font-size: 12px;
      color: #8892b0;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .alerts-count {
      background: #dc2626;
      color: #ffffff;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .alerts-list {
      list-style: none;
    }

    .alerts-list li {
      padding: 8px 0;
      border-bottom: 1px solid #1e293b;
      color: #e2e8f0;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .alerts-list li:last-child {
      border-bottom: none;
    }

    .alert-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #dc2626;
      flex-shrink: 0;
      position: relative;
    }

    .alert-icon::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 6px;
      height: 6px;
      background: #ffffff;
      border-radius: 50%;
    }

    .loading, .no-alerts, .error {
      background: #1a1f2e;
      border: 1px solid #2a3441;
      border-radius: 4px;
      padding: 60px;
      text-align: center;
      color: #8892b0;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .error {
      color: #dc2626;
      border-color: #dc2626;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 2px solid #2a3441;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .header h1 {
        font-size: 24px;
      }

      .stats-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .controls-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .alerts-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .vitals-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .alert-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 16px;
      }

      .stat-card, .controls, .vitals-container, .alerts-section {
        padding: 16px;
      }

      .patient-id {
        font-size: 14px;
      }

      .vital-value {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Patient Monitoring System</h1>
      <div class="subtitle">Critical Care Unit - Real-time Patient Surveillance</div>
      <div class="header-buttons">
          <button class="header-btn history" id="patient-history-btn">
            Patient History
          </button>
          <button class="header-btn logout" id="logout-btn">
            Logout
          </button>
        </div>
      </div>

      <div class="stats-container">
        <div class="stat-card normal">
          <div class="stat-header">
            <div class="stat-title">Total Patients</div>
            <div class="stat-status"></div>
          </div>
          <div class="stat-value" id="total-patients">0</div>
          <div class="stat-change">Currently monitored</div>
        </div>
        
        <div class="stat-card critical">
          <div class="stat-header">
            <div class="stat-title">Critical Alerts</div>
            <div class="stat-status critical"></div>
          </div>
          <div class="stat-value" id="critical-alerts">0</div>
          <div class="stat-change">Immediate attention required</div>
        </div>
        
        <div class="stat-card warning">
          <div class="stat-header">
            <div class="stat-title">Warning Alerts</div>
            <div class="stat-status warning"></div>
          </div>
          <div class="stat-value" id="warning-alerts">0</div>
          <div class="stat-change">Monitoring required</div>
        </div>
        
        <div class="stat-card normal">
          <div class="stat-header">
            <div class="stat-title">Stable Patients</div>
            <div class="stat-status"></div>
          </div>
          <div class="stat-value" id="stable-patients">0</div>
          <div class="stat-change">Within normal parameters</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="controls-grid">
        <div class="search-container">
          <div class="search-icon">🔍</div>
          <input type="text" class="search-input" id="search-input" placeholder="Search Patient ID...">
        </div>
        
        <select class="filter-select" id="severity-filter">
          <option value="all">All Patients</option>
          <option value="critical">Critical Only</option>
          <option value="warning">Warning Only</option>
          <option value="normal">Stable Only</option>
        </select>
        
        <button class="refresh-btn" id="refresh-btn">
          Refresh Data
        </button>
        
        <div class="status-indicator" id="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Live Feed</span>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>Loading patient data...</div>
    </div>
    
    <div id="error" class="error" style="display:none;">
      <div>Failed to load patient data. Please check your connection and try again.</div>
    </div>
    
    <div id="alerts" class="alerts-grid"></div>
    
    <div id="no-alerts" class="no-alerts" style="display:none;">
      No alerts matching current filters. All monitored patients are stable.
    </div>
  </div>

  <script>
    // Configuration - Using your working API endpoint
    const API_URL = 'https://y7v33u53u2.execute-api.eu-north-1.amazonaws.com/get-recent-alerts';
    const REFRESH_INTERVAL = 30000; // 30 seconds

    // Global state
    let patientsData = [];
    let filteredPatientsData = [];
    let refreshInterval;
    let isLoading = false;

    // DOM elements
    const elements = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      alerts: document.getElementById('alerts'),
      noAlerts: document.getElementById('no-alerts'),
      searchInput: document.getElementById('search-input'),
      severityFilter: document.getElementById('severity-filter'),
      refreshBtn: document.getElementById('refresh-btn'),
      statusDot: document.getElementById('status-dot'),
      statusText: document.getElementById('status-text'),
      totalPatients: document.getElementById('total-patients'),
      criticalAlerts: document.getElementById('critical-alerts'),
      warningAlerts: document.getElementById('warning-alerts'),
      stablePatients: document.getElementById('stable-patients')
    };

    // Function to determine alert level based on vitals
    function getAlertLevel(heartRate, oxygen) {
      const hr = parseInt(heartRate);
      const o2 = parseInt(oxygen);
      
      // Critical conditions
      if (hr > 120 || hr < 50 || o2 < 90) {
        return 'critical';
      }
      // Warning conditions
      if (hr > 100 || hr < 60 || o2 < 95) {
        return 'warning';
      }
      // Normal
      return 'normal';
    }

    // Function to generate alerts based on vitals
    function generateAlerts(heartRate, oxygen) {
      const alerts = [];
      const hr = parseInt(heartRate);
      const o2 = parseInt(oxygen);
      
      if (hr > 120) alerts.push('Tachycardia - High heart rate detected');
      if (hr < 50) alerts.push('Bradycardia - Low heart rate detected');
      if (o2 < 90) alerts.push('Critical oxygen saturation');
      if (o2 < 95 && o2 >= 90) alerts.push('Low oxygen saturation');
      if (hr > 100 && hr <= 120) alerts.push('Elevated heart rate');
      if (hr < 60 && hr >= 50) alerts.push('Low heart rate');
      
      return alerts;
    }

    // UI Functions
    function showLoading() {
      elements.loading.style.display = 'flex';
      elements.error.style.display = 'none';
      elements.alerts.style.display = 'none';
      elements.noAlerts.style.display = 'none';
    }

    function showError(message) {
      elements.loading.style.display = 'none';
      elements.error.style.display = 'block';
      elements.error.innerHTML = `<div>${message}</div>`;
      elements.alerts.style.display = 'none';
      elements.noAlerts.style.display = 'none';
      
      // Update status indicator
      elements.statusDot.className = 'status-dot error';
      elements.statusText.textContent = 'Connection Error';
    }

    function showPatients(patients) {
      elements.loading.style.display = 'none';
      elements.error.style.display = 'none';
      
      if (patients.length === 0) {
        elements.alerts.style.display = 'none';
        elements.noAlerts.style.display = 'block';
      } else {
        elements.alerts.style.display = 'grid';
        elements.noAlerts.style.display = 'none';
        renderPatients(patients);
      }
      
      // Update status indicator
      elements.statusDot.className = 'status-dot';
      elements.statusText.textContent = 'Live Feed';
    }

    function renderPatients(patients) {
      elements.alerts.innerHTML = '';
      
      patients.forEach(patient => {
        const patientCard = createPatientCard(patient);
        elements.alerts.appendChild(patientCard);
      });
    }

    function createPatientCard(patient) {
      const card = document.createElement('div');
      const alertLevel = getAlertLevel(patient.heart_rate, patient.oxygen);
      const alerts = generateAlerts(patient.heart_rate, patient.oxygen);
      
      card.className = `alert-card ${alertLevel}`;
      
      const timestamp = new Date(patient.timestamp).toLocaleString();
      const alertsHtml = alerts.map(alert => `
        <li>
          <div class="alert-icon"></div>
          ${alert}
        </li>
      `).join('');

      card.innerHTML = `
        <div class="alert-header">
          <div class="patient-info">
            <div>
              <div class="patient-id">${patient.patient_id}</div>
              <div class="patient-status">ICU Patient</div>
              <div class="timestamp">Last Update: ${timestamp}</div>
            </div>
          </div>
          <div class="severity-indicator ${alertLevel}">
            <div class="severity-dot"></div>
            ${getSeverityText(alertLevel)}
          </div>
        </div>
        <div class="vitals-container">
          <div class="vitals-grid">
            <div class="vital-reading heart-rate ${(parseInt(patient.heart_rate) > 120 || parseInt(patient.heart_rate) < 50) ? 'critical' : ''}">
              <div class="vital-label">Heart Rate</div>
              <div class="vital-value">${patient.heart_rate}</div>
              <div class="vital-unit">BPM</div>
            </div>
            <div class="vital-reading oxygen ${parseInt(patient.oxygen) < 90 ? 'critical' : ''}">
              <div class="vital-label">Oxygen Saturation</div>
              <div class="vital-value">${patient.oxygen}</div>
              <div class="vital-unit">%</div>
            </div>
          </div>
          <div class="alerts-section">
            <div class="alerts-title">
              Active Alerts 
              <span class="alerts-count">${alerts.length}</span>
            </div>
            <ul class="alerts-list">
              ${alertsHtml || '<li style="color: #059669;">All vitals within normal range</li>'}
            </ul>
          </div>
        </div>
      `;
      
      return card;
    }

    function getSeverityText(alertLevel) {
      switch(alertLevel) {
        case 'critical':
          return 'Critical';
        case 'warning':
          return 'Warning';
        default:
          return 'Normal';
      }
    }

    function updateStatistics(patients) {
      const totalPatients = patients.length;
      const criticalCount = patients.filter(p => getAlertLevel(p.heart_rate, p.oxygen) === 'critical').length;
      const warningCount = patients.filter(p => getAlertLevel(p.heart_rate, p.oxygen) === 'warning').length;
      const stableCount = patients.filter(p => getAlertLevel(p.heart_rate, p.oxygen) === 'normal').length;
      
      elements.totalPatients.textContent = totalPatients;
      elements.criticalAlerts.textContent = criticalCount;
      elements.warningAlerts.textContent = warningCount;
      elements.stablePatients.textContent = stableCount;
    }

    function filterPatients() {
      const searchTerm = elements.searchInput.value.toLowerCase();
      const severityFilter = elements.severityFilter.value;
      
      filteredPatientsData = patientsData.filter(patient => {
        const alertLevel = getAlertLevel(patient.heart_rate, patient.oxygen);
        const matchesSearch = patient.patient_id.toLowerCase().includes(searchTerm);
        const matchesSeverity = severityFilter === 'all' || 
                               (severityFilter === 'critical' && alertLevel === 'critical') ||
                               (severityFilter === 'warning' && alertLevel === 'warning') ||
                               (severityFilter === 'normal' && alertLevel === 'normal');
        
        return matchesSearch && matchesSeverity;
      });
      
      showPatients(filteredPatientsData);
      updateStatistics(filteredPatientsData);
    }

    // Data loading function - using your working API
    async function fetchPatientData() {
      if (isLoading) return;
      
      isLoading = true;
      elements.refreshBtn.disabled = true;
      elements.refreshBtn.textContent = 'Loading...';
      
      try {
        showLoading();
        const response = await fetch(API_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const json = await response.json();
        const data = json.data || json; // adapt based on Lambda output
        
        patientsData = data;
        filterPatients();
        console.log(`Loaded ${patientsData.length} patients`);
        
      } catch (error) {
        console.error('Error loading patients:', error);
        showError('Failed to load patient data. Please check your connection and try again.');
      } finally {
        isLoading = false;
        elements.refreshBtn.disabled = false;
        elements.refreshBtn.textContent = 'Refresh Data';
      }
    }

    // Event listeners
    function setupEventListeners() {
      elements.searchInput.addEventListener('input', filterPatients);
      elements.severityFilter.addEventListener('change', filterPatients);
      elements.refreshBtn.addEventListener('click', fetchPatientData);
      
      // Auto-refresh setup
      refreshInterval = setInterval(fetchPatientData, REFRESH_INTERVAL);
    }

    // Initialize the application
    function init() {
      setupEventListeners();
      fetchPatientData();
    }

    // Start the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
  
   <script>
// Listen for auth tokens from parent window
window.addEventListener('message', (event) => {
  if (event.data.type === 'AUTH_TOKENS') {
    window.userTokens = event.data.tokens;
    console.log('User logged in:', event.data.tokens.profile.email);
  }
});

// Logout functionality
document.getElementById('logout-btn').addEventListener('click', () => {
  // Call the logout function from parent window
  if (window.parent && window.parent.logout) {
    window.parent.logout();
  } else {
    // Fallback if parent logout function not available
    window.location.href = 'index.html';
  }
});

// Add this to your main dashboard's JavaScript
document.getElementById('patient-history-btn').addEventListener('click', function() {
    window.open('patient-history.html', '_blank');
});


</script>
</body>
</html>

 

